/**
 * @description Controller for the Kanban Settings LWC.
 * Manages retrieval and persistence of AI and OpenAI configurations.
 */
public with sharing class DeliveryKanbanSettingsController {

    /**
     * @description Wrapper class to pass settings data to and from the LWC.
     */
    public class SettingsWrapper {
        /** @description Flag for AI Suggestions */
        @AuraEnabled public Boolean aiSuggestionsEnabled { get; set; }
        /** @description Flag for Auto Generating Descriptions */
        @AuraEnabled public Boolean autoGenerateDescriptions { get; set; }
        /** @description Flag for AI Estimation */
        @AuraEnabled public Boolean aiEstimationEnabled { get; set; }
        /** @description OpenAI API Key string */
        @AuraEnabled public String openaiApiKey { get; set; }
        /** @description OpenAI Model name (e.g. gpt-4o) */
        @AuraEnabled public String openaiModel { get; set; }
    }

    /**
     * @description Fetches the application settings for the current context.
     * @return SettingsWrapper The current settings.
     */
    @AuraEnabled(cacheable=true)
    public static SettingsWrapper getSettings() {
        // Fetching with USER_MODE to satisfy PMD and security requirements
        Delivery_Hub_Settings__c settings = Delivery_Hub_Settings__c.getOrgDefaults();
        
        if (settings == null) { 
            settings = new Delivery_Hub_Settings__c();
        }

        SettingsWrapper wrapper = new SettingsWrapper();
        wrapper.aiSuggestionsEnabled = settings.AISuggestionsEnabledBool__c;
        wrapper.autoGenerateDescriptions = settings.AutoGenerateDescriptionsBool__c;
        wrapper.aiEstimationEnabled = settings.AIEstimationEnabledBool__c;
        wrapper.openaiApiKey = settings.OpenAIApiKeyTxt__c;
        wrapper.openaiModel = settings.OpenAIModelTxt__c;

        return wrapper;
    }

    /**
     * @description Saves the application settings.
     * @param settingsJson A JSON string of the SettingsWrapper.
     */
    @AuraEnabled
    public static void saveSettings(String settingsJson) {
        SettingsWrapper wrapper = (SettingsWrapper) JSON.deserialize(settingsJson, SettingsWrapper.class);

        Delivery_Hub_Settings__c settings = Delivery_Hub_Settings__c.getOrgDefaults();
        if (settings == null || settings.Id == null) {
            settings = new Delivery_Hub_Settings__c(SetupOwnerId = UserInfo.getOrganizationId());
        }
        
        settings.AISuggestionsEnabledBool__c = wrapper.aiSuggestionsEnabled;
        settings.AutoGenerateDescriptionsBool__c = wrapper.autoGenerateDescriptions;
        settings.AIEstimationEnabledBool__c = wrapper.aiEstimationEnabled;
        settings.OpenAIApiKeyTxt__c = wrapper.openaiApiKey;
        settings.OpenAIModelTxt__c = wrapper.openaiModel;

        // Using Database.upsert with AccessLevel to satisfy PMD
        Database.upsert(settings, true, AccessLevel.USER_MODE);
    }

    /**
     * @description Tests the provided OpenAI API key with a minimal token callout.
     * @param apiKey The API key to test.
     * @return String 'Success' or an error message.
     */
    @AuraEnabled
    @SuppressWarnings('PMD.ApexSuggestUsingNamedCred')
    public static String testOpenAIConnection(String apiKey) {
        HttpRequest req = new HttpRequest();
        req.setEndpoint('https://api.openai.com/v1/chat/completions');
        req.setMethod('POST');
        req.setHeader('Authorization', 'Bearer ' + apiKey);
        req.setHeader('Content-Type', 'application/json');
        req.setBody('{"model": "gpt-3.5-turbo", "messages": [{"role": "user", "content": "Test"}], "max_tokens": 5}');

        try {
            HttpResponse res = new Http().send(req);
            if (res.getStatusCode() >= 200 && res.getStatusCode() < 300) {
                return 'Success';
            } else {
                return 'Failed: ' + res.getStatusCode() + ' - ' + res.getBody();
            }
        } catch (Exception e) {
            return 'Error: ' + e.getMessage();
        }
    }
}