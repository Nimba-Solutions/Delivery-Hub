/**
 * @description Test class for DeliveryKanbanSettingsController.
 * Verifies the retrieval, saving, and connection testing of Kanban settings.
 */
@isTest
private class DeliveryKanbanSettingsControllerTest {

    // =================================================================================
    // SECTION 1: getSettings() and saveSettings() Tests
    // =================================================================================

    /**
     * @description Verifies that getSettings returns org defaults when no record exists.
     */
    @isTest
    static void testGetSettings_NoExistingRecord() {
        Test.startTest();
        // ACT: Call getSettings(). It should return the org defaults.
        DeliveryKanbanSettingsController.SettingsWrapper settings = DeliveryKanbanSettingsController.getSettings();
        Test.stopTest();

        // ASSERT: The returned object should not be null and should reflect default values.
        System.assertNotEquals(null, settings, 'Settings wrapper should not be null even if no record exists.');
        System.assertEquals(false, settings.aiSuggestionsEnabled, 'Default for AI Suggestions should be false.');
    }

    /**
     * @description Verifies the full cycle of saving and then retrieving settings via JSON.
     */
    @isTest
    static void testGetAndSaveSettings_FullCycle() {
        // ARRANGE: Create a wrapper object with all properties set.
        DeliveryKanbanSettingsController.SettingsWrapper newSettings = new DeliveryKanbanSettingsController.SettingsWrapper();
        newSettings.aiSuggestionsEnabled = true;
        newSettings.autoGenerateDescriptions = true;
        newSettings.aiEstimationEnabled = false; 
        newSettings.openaiApiKey = 'sk-test-key';
        newSettings.openaiModel = 'gpt-4';

        // Serialize the wrapper to JSON, mimicking the LWC payload.
        String settingsJson = JSON.serialize(newSettings);

        Test.startTest();
        // ACT 1: Save the settings.
        DeliveryKanbanSettingsController.saveSettings(settingsJson);

        // ACT 2: Retrieve the settings to verify they were saved correctly.
        DeliveryKanbanSettingsController.SettingsWrapper savedSettings = DeliveryKanbanSettingsController.getSettings();
        Test.stopTest();

        // ASSERT: All retrieved settings should match the values that were saved.
        System.assertNotEquals(null, savedSettings, 'Retrieved settings should not be null.');
        System.assertEquals(true, savedSettings.aiSuggestionsEnabled, 'AI Suggestions should be true.');
        System.assertEquals(false, savedSettings.aiEstimationEnabled, 'AI Estimation should be false.');
        System.assertEquals('sk-test-key', savedSettings.openaiApiKey, 'OpenAI API key should match.');
    }

    // =================================================================================
    // SECTION 2: testOpenAIConnection() Callout Tests
    // =================================================================================

    /**
     * @description Verifies successful OpenAI connection response.
     */
    @isTest
    static void testOpenAIConnection_Success() {
        Test.setMock(HttpCalloutMock.class, new OpenAIMock(200, 'Success', '{"id":"...","choices":[{"message":{"content":"Test successful."}}]}'));

        Test.startTest();
        String result = DeliveryKanbanSettingsController.testOpenAIConnection('dummy-key');
        Test.stopTest();

        System.assertEquals('Success', result, 'The connection test should return "Success" on a 200 response.');
    }

    /**
     * @description Verifies OpenAI connection failure handling for API errors.
     */
    @isTest
    static void testOpenAIConnection_ApiError() {
        String errorBody = '{"error":{"message":"Incorrect API key provided."}}';
        Test.setMock(HttpCalloutMock.class, new OpenAIMock(401, 'Unauthorized', errorBody));

        Test.startTest();
        String result = DeliveryKanbanSettingsController.testOpenAIConnection('invalid-key');
        Test.stopTest();

        System.assert(result.contains('Failed: 401'), 'The result should indicate a failed status code.');
        System.assert(result.contains('Incorrect API key provided'), 'The result should include the error message from the API.');
    }

    // =================================================================================
    // SECTION 3: HTTP Mock Implementation
    // =================================================================================

    /**
     * @description Mock class to simulate responses from the OpenAI API.
     */
    private class OpenAIMock implements HttpCalloutMock {
        private Integer statusCode;
        private String status;
        private String body;
        private Boolean throwException;

        /**
         * @description Constructor for standard responses.
         * @param statusCode HTTP Status Code.
         * @param status HTTP Status String.
         * @param body Response body string.
         */
        public OpenAIMock(Integer statusCode, String status, String body) {
            this.statusCode = statusCode;
            this.status = status;
            this.body = body;
            this.throwException = false;
        }

        /**
         * @description Constructor to simulate a system-level exception.
         * @param throwEx Whether to throw a CalloutException.
         */
        public OpenAIMock(Boolean throwEx) {
            this.throwException = throwEx;
        }

        /**
         * @description Required respond method for HttpCalloutMock.
         * @param req The HTTP Request.
         * @return The Mocked Response.
         */
        public HttpResponse respond(HttpRequest req) {
            if (this.throwException) {
                throw new CalloutException('Callout failed');
            }

            HttpResponse res = new HttpResponse();
            res.setHeader('Content-Type', 'application/json');
            res.setBody(this.body);
            res.setStatusCode(this.statusCode);
            res.setStatus(this.status);
            return res;
        }
    }
}