/**
 * @description Controller for the Delivery Hub Setup LWC.
 * Handles connecting to the mothership (Nimba) and initializing app defaults.
 */
public with sharing class DeliveryHubSetupController {

    public class SetupStatus {
        @AuraEnabled public Boolean isConnected;
        @AuraEnabled public String requiredRemoteSite;
        @AuraEnabled public Network_Entity__c entity;
    }

    @AuraEnabled(cacheable=true)
    public static SetupStatus getSetupStatus() {
        SetupStatus status = new SetupStatus();
        
        // 1. Define the Remote Site URL we need
        status.requiredRemoteSite = 'https://orgfarm-8e4cff452b-dev-ed.develop.my.salesforce-sites.com';

        // 2. Check for existing Network Entity
        List<Network_Entity__c> entities = [
            SELECT Id, Name, StatusPk__c, IntegrationEndpointUrlTxt__c 
            FROM Network_Entity__c 
            WHERE Name = 'Nimba Solutions (Dev Team)' 
            LIMIT 1
        ];

        if (!entities.isEmpty()) {
            status.isConnected = true;
            status.entity = entities[0];
        } else {
            status.isConnected = false;
        }

        return status;
    }

    /**
     * @description Creates the Network Entity and initializes Default Settings.
     */
    @AuraEnabled
    public static void connectToDefaultMothership() {
        // 1. Create Network Entity if it doesn't exist
        List<Network_Entity__c> existing = [
            SELECT Id FROM Network_Entity__c 
            WHERE Name = 'Nimba Solutions (Dev Team)' 
            LIMIT 1
        ];

        if (existing.isEmpty()) {
            Network_Entity__c mothership = new Network_Entity__c(
                Name = 'Nimba Solutions (Dev Team)',
                StatusPk__c = 'Active',
                EntityTypePk__c = 'Vendor',
                IntegrationEndpointUrlTxt__c = 'https://orgfarm-8e4cff452b-dev-ed.develop.my.salesforce-sites.com/services/apexrest/Tickets'
            );
            
            // Check permissions
            if (Schema.sObjectType.Network_Entity__c.isCreateable()) {
                insert mothership;
            }
        }

        // 2. Initialize Delivery Hub Settings (Quickstart Configuration)
        initializeDefaultSettings();
    }

    /**
     * @description Ensures the Custom Setting record exists with sensible "Happy Path" defaults.
     */
    private static void initializeDefaultSettings() {
        Delivery_Hub_Settings__c settings = Delivery_Hub_Settings__c.getOrgDefaults();

        // If no record exists (Id is null), we create one with defaults.
        // If one exists, we leave it alone so we don't overwrite user choices.
        if (settings.Id == null) {
            settings = new Delivery_Hub_Settings__c(SetupOwnerId = UserInfo.getOrganizationId());
            
            // --- SET YOUR "HAPPY PATH" DEFAULTS HERE ---
            settings.AutoSyncNetworkEntityBool__c = true;
            settings.EnableNotificationsBool__c = true;
            settings.AISuggestionsEnabledBool__c = true; 
            settings.AutoGenerateDescriptionsBool__c = true;
            settings.AIEstimationEnabledBool__c = true;
            
            // Note: We don't default API keys or JIRA credentials as those are sensitive/specific
            
            if (Schema.sObjectType.Delivery_Hub_Settings__c.isCreateable()) {
                insert settings;
            }
        }
    }
}