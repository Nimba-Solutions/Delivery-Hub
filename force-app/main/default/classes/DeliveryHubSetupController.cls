/**
 * @description Controller for the Delivery Hub Setup LWC.
 * Handles connecting to the mothership (Cloud Nimbus LLC) and initializing app defaults.
 */
public without sharing class DeliveryHubSetupController {

    /**
     * @description Data Transfer Object to pass setup status to the LWC.
     */
    public class SetupStatus {
        @AuraEnabled public Boolean isConnected;
        @AuraEnabled public String requiredRemoteSite;
        @AuraEnabled public Network_Entity__c entity;
    }

    /**
     * @description Checks the current connection status.
     */
    @AuraEnabled(cacheable=true)
    public static SetupStatus getSetupStatus() {
        SetupStatus status = new SetupStatus();
        status.requiredRemoteSite = 'https://orgfarm-928a77dfd6-dev-ed.develop.my.salesforce-sites.com';

        List<Network_Entity__c> entities = [
            SELECT Id, Name, StatusPk__c, IntegrationEndpointUrlTxt__c 
            FROM Network_Entity__c 
            WHERE Name = 'Cloud Nimbus LLC (Nimba Solutions Partner Portal Dev Team)' 
            LIMIT 1
        ];

        if (!entities.isEmpty()) {
            status.isConnected = true;
            status.entity = entities[0];
        } else {
            status.isConnected = false;
        }
        return status;
    }

    /**
     * @description Connects the org, initializes settings, sends registration ticket, AND starts the sync heartbeat.
     */
    @AuraEnabled
    public static void connectToDefaultMothership() {
        // 1. Create/Find Network Entity
        List<Network_Entity__c> existing = [
            SELECT Id FROM Network_Entity__c 
            WHERE Name = 'Cloud Nimbus LLC (Nimba Solutions Partner Portal Dev Team)' 
            LIMIT 1
        ];

        if (existing.isEmpty()) {
            Network_Entity__c mothership = new Network_Entity__c(
                Name = 'Cloud Nimbus LLC (Nimba Solutions Partner Portal Dev Team)',
                StatusPk__c = 'Active',
                EntityTypePk__c = 'Vendor',
                IntegrationEndpointUrlTxt__c = 'https://orgfarm-928a77dfd6-dev-ed.develop.my.salesforce-sites.com/services/apexrest/delivery/deliveryhub/v1'
            );
            
            if (Schema.sObjectType.Network_Entity__c.isCreateable()) {
                insert mothership;
            } else {
                throw new AuraHandledException('Insufficient permissions to create Network Entity.');
            }
        }

        // 2. Initialize Settings
        initializeDefaultSettings();

        // 3. Create Registration Ticket
        List<Ticket__c> existingReg = [
            SELECT Id FROM Ticket__c 
            WHERE WorkItemNameTxt__c = 'New Org Connection' 
            LIMIT 1
        ];
        
        if (existingReg.isEmpty()) {
            String orgContext = 'Auto-generated registration.\n\n' +
                                'Org Name: ' + UserInfo.getOrganizationName() + '\n' +
                                'Org ID: ' + UserInfo.getOrganizationId() + '\n' +
                                'Instance URL: ' + Url.getOrgDomainUrl().toExternalForm() + '\n' +
                                'Registered By: ' + UserInfo.getName() + ' (' + UserInfo.getUserEmail() + ')';

            Ticket__c regTicket = new Ticket__c(
                WorkItemNameTxt__c = 'New Org Connection',
                BriefDescriptionTxt__c = 'New Delivery Hub Installation: ' + UserInfo.getOrganizationName(),
                DetailsTxt__c = orgContext,
                StageNamePk__c = 'Backlog',
                PriorityPk__c = 'High'
            );

            if (Schema.sObjectType.Ticket__c.isCreateable()) {
                insert regTicket;
            }
        }
        
        // 4. Start the Sync Heartbeat immediately
        scheduleSyncJobs();
    }

    private static void initializeDefaultSettings() {
        Delivery_Hub_Settings__c settings = Delivery_Hub_Settings__c.getOrgDefaults();
        
        if (settings.Id == null) {
            settings = new Delivery_Hub_Settings__c(SetupOwnerId = UserInfo.getOrganizationId());
            settings.EnableNotificationsBool__c = true;
            settings.AutoCreateRequestFromTicketBool__c = true; 
            settings.AutoSyncNetworkEntityBool__c = true;       
            settings.AISuggestionsEnabledBool__c = true; 
            settings.AutoGenerateDescriptionsBool__c = true;
            settings.AIEstimationEnabledBool__c = true;
            settings.StagesToAutoShareWithDevTeamTxt__c = 'All';
            
            if (Schema.sObjectType.Delivery_Hub_Settings__c.isCreateable()) {
                insert settings;
            }
        }
    }

    /**
     * @description Schedules the background jobs (Poller) to keep data in sync.
     */
    private static void scheduleSyncJobs() {
        // Check if jobs already exist to prevent duplicate errors
        Integer jobCount = [SELECT Count() FROM CronTrigger WHERE CronJobDetail.Name LIKE 'Delivery Hub Sync%'];
        
        if (jobCount == 0) {
            // Schedule every 15 minutes
            System.schedule('Delivery Hub Sync - :00', '0 0 * * * ?', new DeliveryHubScheduler());
            System.schedule('Delivery Hub Sync - :15', '0 15 * * * ?', new DeliveryHubScheduler());
            System.schedule('Delivery Hub Sync - :30', '0 30 * * * ?', new DeliveryHubScheduler());
            System.schedule('Delivery Hub Sync - :45', '0 45 * * * ?', new DeliveryHubScheduler());
        }
    }
}