/**
 * @description Controller for sending Requests and Sync Payloads to Vendor(s) via REST API.
 * Handles the "Fan-Out" logic to ensure updates reach all connected Motherships.
 */
public without sharing class DeliveryHubSender {

    /**
     * @description Helper to get the Default Endpoint from Custom Metadata.
     * Replaces the hardcoded DEFAULT_BASE_URL.
     * @return String The configured endpoint URL or an empty string if missing.
     */
    private static String getDefaultBaseUrl() {
        Cloud_Nimbus_LLC_Marketing__mdt config = Cloud_Nimbus_LLC_Marketing__mdt.getInstance('Cloud_Nimbus_LLC_Marketing_Enabled');
        if (config != null && String.isNotBlank(config.CloudNimbusLlcEndpointTxt__c)) {
            return config.CloudNimbusLlcEndpointTxt__c.removeEnd('/');
        }
        return ''; // Or handle as an error if critical
    }

    /**
     * @description NEW: Generic Sender for High-Water Mark Sync.
     * Fans out the update to ALL Vendors linked to the Ticket via Requests.
     * @param objectType The API name (e.g., 'Ticket__c').
     * @param localRecordId The ID of the record being synced (Ticket ID).
     * @param jsonPayload The 'Delta' JSON generated by SyncEngine.
     */
    public static void sendSyncPayload(String objectType, String localRecordId, String jsonPayload) {
        
        Id ticketId = (Id)localRecordId;

        List<Request__c> activeRequests = [
            SELECT Id, RemoteTicketIdTxt__c, DeliveryEntityId__r.IntegrationEndpointUrlTxt__c, DeliveryEntityId__r.Name
            FROM Request__c 
            WHERE TicketId__c = :ticketId 
            AND RemoteTicketIdTxt__c != NULL
            AND DeliveryEntityId__r.StatusPk__c = 'Active'
            WITH SYSTEM_MODE
        ];

        if (activeRequests.isEmpty()) {
            System.debug(LoggingLevel.INFO, 'Sync Skipped: No active linked Requests found for Ticket ' + ticketId);
            return; 
        }

        for (Request__c req : activeRequests) {
            sendToSpecificVendor(req, objectType, jsonPayload);
        }
    }

    /**
     * @description Helper to send the payload to a specific Vendor found in the loop.
     * @param reqRec The Request context containing Vendor URL and Remote ID.
     * @param objectType The API Name of the object.
     * @param originalPayload The generic payload string.
     */
    private static void sendToSpecificVendor(Request__c reqRec, String objectType, String originalPayload) {
        String baseUrl = (String.isNotBlank(reqRec.DeliveryEntityId__r.IntegrationEndpointUrlTxt__c))
            ? reqRec.DeliveryEntityId__r.IntegrationEndpointUrlTxt__c
            : getDefaultBaseUrl(); // --- FIX: Use Metadata Helper ---

        if (String.isBlank(baseUrl)) {
            System.debug(LoggingLevel.ERROR, 'Sync Failed: No Endpoint URL configured.');
            return;
        }

        if (!baseUrl.endsWith('/')) {
            baseUrl += '/';
        }

        // Detect the remote org's namespace from the Sites URL path.
        String remoteObjectType = objectType;
        if (baseUrl.contains('/apexrest/')) {
            String afterApexrest = baseUrl.substring(baseUrl.indexOf('/apexrest/') + 10);
            String firstSegment = afterApexrest.split('/')[0];
            if (firstSegment != 'deliveryhub' && String.isNotBlank(firstSegment)) {
                remoteObjectType = firstSegment + '__' + objectType;
            }
        }
        String fullEndpoint = baseUrl + 'sync/' + remoteObjectType;

        // Inject the Specific Remote ID for THIS Vendor
        Map<String, Object> payloadMap = (Map<String, Object>) JSON.deserializeUntyped(originalPayload);
        payloadMap.put('TargetId', reqRec.RemoteTicketIdTxt__c);
        String finalJson = JSON.serialize(payloadMap);

        HttpRequest req = new HttpRequest();
        req.setEndpoint(fullEndpoint);
        req.setMethod('POST');
        req.setHeader('Content-Type', 'application/json');
        req.setBody(finalJson);
        req.setTimeout(120000);

        Http http = new Http();
        HttpResponse res = http.send(req);

        if (res.getStatusCode() != 200 && res.getStatusCode() != 201) {
            throw new CalloutException('Sync Failed (' + res.getStatusCode() + '): ' + res.getBody());
        }
    }

    // ============================================================================
    // LEGACY / REQUEST BROKERAGE METHODS
    // ============================================================================
    
    /**
     * @description LWC-callable method to send a request. Wraps sync logic with Aura exception handling.
     * @param requestId The ID of the Request record to send.
     * @return String 'Success' on successful transmission or an error message.
     */
    @AuraEnabled
    public static String sendRequestToVendor(Id requestId) {
        try {
            return sendRequestSync(requestId);
        } catch (Exception e) {
            System.debug(LoggingLevel.ERROR, 'Brokerage Error Details: ' + e.getMessage());
            throw new AuraHandledException('Brokerage Error: ' + e.getMessage());
        }
    }

    /**
     * @description Core synchronous logic to send request. Callable by Queueable/Apex.
     * @param requestId The ID of the Request record to send.
     * @return String 'Success' on successful transmission.
     */
    @SuppressWarnings('PMD.ApexCRUDViolation') 
    public static String sendRequestSync(Id requestId) {
        Request__c reqRec = [
            SELECT Id, Name, PreApprovedHoursNumber__c, HourlyRateCurrency__c, 
                   TicketId__r.WorkItemNameTxt__c, TicketId__r.BriefDescriptionTxt__c, 
                   TicketId__r.DetailsTxt__c, TicketId__r.PriorityPk__c, TicketId__r.WorkItemTypeTxt__c, DeliveryEntityId__c,
                   DeliveryEntityId__r.IntegrationEndpointUrlTxt__c, DeliveryEntityId__r.Name, DeliveryEntityId__r.RemoteExternalIdTxt__c, DeliveryEntityId__r.OrgIdTxt__c
            FROM Request__c 
            WHERE Id = :requestId 
            WITH SYSTEM_MODE
            LIMIT 1
        ];

        String baseUrl = reqRec.DeliveryEntityId__r.IntegrationEndpointUrlTxt__c;
        if (String.isBlank(baseUrl)) {
            baseUrl = getDefaultBaseUrl(); // --- FIX: Use Metadata Helper ---
        }

        if (String.isBlank(baseUrl)) {
            throw new CalloutException('Configuration Error: No Endpoint URL found on Network Entity or Custom Metadata.');
        }

        if (!baseUrl.endsWith('/')) {
            baseUrl += '/';
        }
        String fullEndpoint = baseUrl + 'intake';

        Map<String, Object> payload = new Map<String, Object>{
            'title' => reqRec.TicketId__r.WorkItemNameTxt__c,
            'briefSummary' => reqRec.TicketId__r.BriefDescriptionTxt__c,
            'detailedContent' => reqRec.TicketId__r.DetailsTxt__c,
            'priority' => reqRec.TicketId__r.PriorityPk__c,
            'type' => reqRec.TicketId__r.WorkItemTypeTxt__c,
            'companyName' => UserInfo.getOrganizationName(),
            'instanceUrl' => Url.getOrgDomainUrl().toExternalForm() + '/services/apexrest/delivery/deliveryhub/v1',
            'orgId' => UserInfo.getOrganizationId(),
            'entityId' => reqRec.DeliveryEntityId__c,
            'preApprovedHours' => reqRec.PreApprovedHoursNumber__c,
            'hourlyRate' => reqRec.HourlyRateCurrency__c,
            'brokerRequestId' => reqRec.Id 
        };

        HttpRequest httpReq = new HttpRequest();
        httpReq.setEndpoint(fullEndpoint);
        httpReq.setMethod('POST');
        httpReq.setHeader('Content-Type', 'application/json');
        httpReq.setBody(JSON.serialize(payload));
        
        Http http = new Http();
        HttpResponse res = http.send(httpReq);
        
        if (res.getStatusCode() == 201 || res.getStatusCode() == 200) {
            String remoteId;
            try {
                Map<String, Object> responseMap = (Map<String, Object>) JSON.deserializeUntyped(res.getBody());
                if (responseMap.containsKey('ticketId')) {
                    remoteId = (String) responseMap.get('ticketId');
                } else if (responseMap.containsKey('id')) {
                    remoteId = (String) responseMap.get('id');
                } else if (responseMap.containsKey('brokerRequestId')) {
                    remoteId = (String) responseMap.get('brokerRequestId');
                }
            } catch(Exception e) {
                remoteId = res.getBody().replace('"', ''); 
            }
            
            reqRec.RemoteTicketIdTxt__c = remoteId;
            reqRec.StatusPk__c = 'Offer Sent'; 
            
            Database.update(reqRec, AccessLevel.SYSTEM_MODE);
            return 'Success';
        } else {
            throw new CalloutException('Network Error (' + res.getStatusCode() + '): ' + res.getBody());
        }
    }

    /**
     * @description Checks the status of a remote ticket via API.
     * @param requestId The ID of the local Request record.
     * @return String Status message from the remote system.
     */
    @AuraEnabled
    public static String checkRequestStatus(Id requestId) {
        try {
            Request__c reqRec = [
                SELECT Id, RemoteTicketIdTxt__c, DeliveryEntityId__r.IntegrationEndpointUrlTxt__c 
                FROM Request__c 
                WHERE Id = :requestId 
                WITH SYSTEM_MODE
                LIMIT 1
            ];

            if (String.isBlank(reqRec.RemoteTicketIdTxt__c)) {
                return 'No Remote ID linked. Have you sent this request yet?';
            }

            String baseUrl = reqRec.DeliveryEntityId__r.IntegrationEndpointUrlTxt__c;
            if (String.isBlank(baseUrl)) {
                baseUrl = getDefaultBaseUrl(); // --- FIX: Use Metadata Helper ---
            }

            if (String.isBlank(baseUrl)) {
                throw new AuraHandledException('Configuration Error: No Endpoint URL found.');
            }

            if (!baseUrl.endsWith('/')) {
                baseUrl += '/';
            }
            String fullEndpoint = baseUrl + 'intake/' + reqRec.RemoteTicketIdTxt__c;

            HttpRequest httpReq = new HttpRequest();
            httpReq.setEndpoint(fullEndpoint);
            httpReq.setMethod('GET');
            
            Http http = new Http();
            HttpResponse res = http.send(httpReq);

            if (res.getStatusCode() == 200) {
                Map<String, Object> responseMap = (Map<String, Object>) JSON.deserializeUntyped(res.getBody());
                String remoteStatus = (String) responseMap.get('status');
                return 'Remote Status: ' + remoteStatus;
            } else {
                return 'Check Failed: ' + res.getStatusCode() + ' ' + res.getStatus();
            }

        } catch (Exception e) {
            throw new AuraHandledException(e.getMessage());
        }
    }
}