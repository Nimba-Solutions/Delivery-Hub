/**
 * @name         Delivery Hub
 * @license      BSL 1.1 â€” See LICENSE.md
 * @description Controller class for managing Delivery Hub application settings
 * Handles General and AI configuration via Custom Settings.
 * @author Cloud Nimbus LLC
 */
public with sharing class DeliveryHubSettingsController {

    /**
     * @description Data Transfer Object for settings data to/from LWC
     */
    public class SettingsDTO {
        /** @description Enable notifications setting */
        @AuraEnabled public Boolean enableNotifications { get; set; }
        
        /** @description Automatically create a Request record when a Work Item is created */
        @AuraEnabled public Boolean autoCreateRequest { get; set; } 
        
        /** @description Automatically send the Request to the Vendor via API */
        @AuraEnabled public Boolean autoSendRequest { get; set; }   
        
        /** @description AI suggestions enabled setting */
        @AuraEnabled public Boolean aiSuggestionsEnabled { get; set; }
        
        /** @description Auto generate descriptions setting */
        @AuraEnabled public Boolean autoGenerateDescriptions { get; set; }
        
        /** @description AI estimation enabled setting */
        @AuraEnabled public Boolean aiEstimationEnabled { get; set; }
        
        /** @description OpenAI API key */
        @AuraEnabled public String openaiApiKey { get; set; }
        
        /** @description OpenAI model name */
        @AuraEnabled public String openaiModel { get; set; }
        
        /** @description OpenAI API tested status */
        @AuraEnabled public Boolean openAiApiTested { get; set; }

        /** @description Slack Incoming Webhook URL */
        @AuraEnabled public String slackWebhookUrl { get; set; }

        /** @description Email notifications on stage changes */
        @AuraEnabled public Boolean emailNotificationsEnabled { get; set; }

        /** @description Show inline board metrics bar on the Kanban board */
        @AuraEnabled public Boolean showBoardMetrics { get; set; }
    }

    /**
     * @description Fetches settings. Not cacheable to ensure fresh reload.
     * @return SettingsDTO The aggregated settings object.
     */
    @AuraEnabled
    public static SettingsDTO getSettings() {
        DeliveryHubSettings__c settings = DeliveryHubSettings__c.getOrgDefaults();
        SettingsDTO dto = new SettingsDTO();

        if (settings != null && settings.Id != null) {
            dto.enableNotifications = settings.EnableNotificationsBool__c;
            
            // Map new fields (using defaults if null)
            dto.autoCreateRequest = (settings.AutoCreateWorkRequestBool__c == null) ? true : settings.AutoCreateWorkRequestBool__c;
            dto.autoSendRequest = (settings.AutoSyncNetworkEntityBool__c == null) ? true : settings.AutoSyncNetworkEntityBool__c;

            // Map other fields
            dto.aiSuggestionsEnabled = settings.AISuggestionsEnabledBool__c;
            dto.autoGenerateDescriptions = settings.AutoGenerateDescriptionsBool__c;
            dto.aiEstimationEnabled = settings.AIEstimationEnabledBool__c;
            dto.openaiApiKey = String.isNotBlank(settings.OpenAIApiKeyTxt__c)
                ? '****' + settings.OpenAIApiKeyTxt__c.right(4)
                : null;
            dto.openaiModel = settings.OpenAIModelTxt__c;
            dto.openAiApiTested = settings.OpenAiApiTestedBool__c;
            dto.slackWebhookUrl = settings.SlackWebhookUrl__c;
            dto.emailNotificationsEnabled = settings.EmailNotificationsEnabledBool__c;
            dto.showBoardMetrics = (settings.ShowBoardMetricsBool__c == null) ? true : settings.ShowBoardMetricsBool__c;
        } else {
            // Fresh Install Defaults
            dto.autoCreateRequest = true;
            dto.autoSendRequest = true;
            dto.enableNotifications = false;
            dto.emailNotificationsEnabled = false;
            dto.showBoardMetrics = true;
        }
        return dto;
    }

    /**
     * @description Helper to get existing settings or create new default settings instance
     * @return DeliveryHubSettings__c settings record
     */
    private static DeliveryHubSettings__c getOrCreateSettings() {
        DeliveryHubSettings__c settings = DeliveryHubSettings__c.getOrgDefaults();
        if (settings == null || settings.Id == null) {
            settings = new DeliveryHubSettings__c(SetupOwnerId = UserInfo.getOrganizationId());
        }
        return settings;
    }

    /**
     * @description Saves general application settings
     * @param enableNotifications Whether to enable notifications
     * @param autoCreateRequest Whether to auto-create Requests
     * @param autoSendRequest Whether to auto-send Requests to Vendor
     * @param emailNotificationsEnabled Whether to send email on stage changes
     * @param showBoardMetrics Whether to show inline board metrics on the Kanban board
     */
    @SuppressWarnings('PMD.ExcessiveParameterList')
    @AuraEnabled
    public static void saveGeneralSettings(Boolean enableNotifications, Boolean autoCreateRequest, Boolean autoSendRequest, Boolean emailNotificationsEnabled, Boolean showBoardMetrics) {
        try {
            DeliveryHubSettings__c settings = getOrCreateSettings();

            settings.EnableNotificationsBool__c = enableNotifications;
            settings.AutoCreateWorkRequestBool__c = autoCreateRequest;
            settings.AutoSyncNetworkEntityBool__c = autoSendRequest;
            settings.EmailNotificationsEnabledBool__c = (emailNotificationsEnabled == true);
            settings.ShowBoardMetricsBool__c = (showBoardMetrics == null) ? true : showBoardMetrics;

            SObjectAccessDecision decision = Security.stripInaccessible(
                AccessType.UPSERTABLE, new List<DeliveryHubSettings__c>{settings});
            upsert decision.getRecords();
        } catch (Exception e) {
            AuraHandledException ahe = new AuraHandledException(e.getMessage());
            ahe.setMessage(e.getMessage());
            throw ahe;
        }
    }
    
    /**
     * @description Saves AI-related settings
     * @param suggestions Enable AI suggestions
     * @param descriptions Enable auto-generate descriptions
     * @param estimation Enable AI estimation
     */
    @AuraEnabled
    public static void saveAiSettings(Boolean suggestions, Boolean descriptions, Boolean estimation) {
        try {
            DeliveryHubSettings__c settings = getOrCreateSettings();

            settings.AISuggestionsEnabledBool__c = suggestions;
            settings.AutoGenerateDescriptionsBool__c = descriptions;
            settings.AIEstimationEnabledBool__c = estimation;

            SObjectAccessDecision decision = Security.stripInaccessible(
                AccessType.UPSERTABLE, new List<DeliveryHubSettings__c>{settings});
            upsert decision.getRecords();
        } catch (Exception e) {
            AuraHandledException ahe = new AuraHandledException(e.getMessage());
            ahe.setMessage(e.getMessage());
            throw ahe;
        }
    }
    
    /**
     * @description Saves OpenAI API settings
     * @param apiKey OpenAI API key
     * @param model OpenAI model name
     * @param tested Whether the API has been tested
     */
    @AuraEnabled
    public static void saveOpenAISettings(String apiKey, String model, boolean tested) {
        try {
            DeliveryHubSettings__c settings = getOrCreateSettings();

            if (String.isNotBlank(apiKey) && !apiKey.startsWith('****')) {
                settings.OpenAIApiKeyTxt__c = apiKey;
            }
            settings.OpenAIModelTxt__c = model;
            settings.OpenAiApiTestedBool__c = tested;

            SObjectAccessDecision decision = Security.stripInaccessible(
                AccessType.UPSERTABLE, new List<DeliveryHubSettings__c>{settings});
            upsert decision.getRecords();
        } catch (Exception e) {
            AuraHandledException ahe = new AuraHandledException(e.getMessage());
            ahe.setMessage(e.getMessage());
            throw ahe;
        }
    }

    /**
     * @description Saves the Slack Incoming Webhook URL to Custom Settings.
     * @param webhookUrl The Slack webhook URL (or blank to clear)
     */
    @AuraEnabled
    public static void saveSlackWebhookUrl(String webhookUrl) {
        try {
            DeliveryHubSettings__c settings = getOrCreateSettings();
            settings.SlackWebhookUrl__c = webhookUrl;
            SObjectAccessDecision decision = Security.stripInaccessible(
                AccessType.UPSERTABLE, new List<DeliveryHubSettings__c>{settings});
            upsert decision.getRecords();
        } catch (Exception e) {
            AuraHandledException ahe = new AuraHandledException(e.getMessage());
            ahe.setMessage(e.getMessage());
            throw ahe;
        }
    }

    /**
     * @description Saves all AI + OpenAI settings from a JSON payload (used by kanban settings container).
     * @param settingsJson JSON string matching SettingsDTO shape
     */
    @AuraEnabled
    public static void saveAllAiSettings(String settingsJson) {
        try {
            SettingsDTO dto = (SettingsDTO) JSON.deserialize(settingsJson, SettingsDTO.class);
            DeliveryHubSettings__c settings = getOrCreateSettings();
            settings.AISuggestionsEnabledBool__c = dto.aiSuggestionsEnabled;
            settings.AutoGenerateDescriptionsBool__c = dto.autoGenerateDescriptions;
            settings.AIEstimationEnabledBool__c = dto.aiEstimationEnabled;
            if (String.isNotBlank(dto.openaiApiKey) && !dto.openaiApiKey.startsWith('****')) {
                settings.OpenAIApiKeyTxt__c = dto.openaiApiKey;
            }
            settings.OpenAIModelTxt__c = dto.openaiModel;
            SObjectAccessDecision decision = Security.stripInaccessible(
                AccessType.UPSERTABLE, new List<DeliveryHubSettings__c>{settings});
            upsert decision.getRecords();
        } catch (Exception e) {
            AuraHandledException ahe = new AuraHandledException(e.getMessage());
            ahe.setMessage(e.getMessage());
            throw ahe;
        }
    }

    /**
     * @description Tests the provided OpenAI API key.
     * @param apiKey The API key to test
     * @return String result message
     */
    @SuppressWarnings('PMD.ApexSuggestUsingNamedCred')
    @AuraEnabled
    public static String testOpenAIConnection(String apiKey) {
        HttpRequest req = new HttpRequest();
        req.setEndpoint('https://api.openai.com/v1/chat/completions');
        req.setMethod('POST');
        req.setHeader('Authorization', 'Bearer ' + apiKey);
        req.setHeader('Content-Type', 'application/json');
        req.setBody('{"model": "gpt-4o-mini", "messages": [{"role": "user", "content": "Test"}], "max_tokens": 5}');

        try {
            HttpResponse res = new Http().send(req);
            if (res.getStatusCode() >= 200 && res.getStatusCode() < 300) {
                return 'Success';
            } else {
                return 'Failed: ' + res.getStatusCode() + ' - ' + res.getBody();
            }
        } catch (Exception e) {
            return 'Error: ' + e.getMessage();
        }
    }
}