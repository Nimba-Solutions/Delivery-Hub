public with sharing class DeliveryHubSettingsController {

    public class SettingsDTO {
        @AuraEnabled public Boolean enableNotifications { get; set; }
        @AuraEnabled public Boolean autoSyncNetworkEntity { get; set; }
        
        // AI & Jira fields...
        @AuraEnabled public Boolean aiSuggestionsEnabled { get; set; }
        @AuraEnabled public Boolean autoGenerateDescriptions { get; set; }
        @AuraEnabled public Boolean aiEstimationEnabled { get; set; }
        @AuraEnabled public String openaiApiKey { get; set; }
        @AuraEnabled public String openaiModel { get; set; }
        @AuraEnabled public Boolean openAiApiTested { get; set; }
        @AuraEnabled public Boolean jiraEnabled { get; set; }
        @AuraEnabled public String jiraInstanceUrl { get; set; }
        @AuraEnabled public String jiraUsername { get; set; }
        @AuraEnabled public String jiraApiToken { get; set; }
        @AuraEnabled public String jiraProjectKey { get; set; }
        @AuraEnabled public Boolean jiraApiTested { get; set; }
    }

    /**
     * @description Fetches settings. Not cacheable to ensure fresh reload.
     */
    @AuraEnabled
    public static SettingsDTO getSettings() {
        Delivery_Hub_Settings__c settings = Delivery_Hub_Settings__c.getOrgDefaults();
        SettingsDTO dto = new SettingsDTO();

        // LOGIC FIX: Check if the record actually exists in the DB
        if (settings.Id == null) {
            // NO RECORD EXISTS (Fresh Install) -> Force Defaults
            dto.autoSyncNetworkEntity = true; // Default TRUE
            dto.enableNotifications = false;  // Default FALSE
        } else {
            // RECORD EXISTS -> Respect whatever is in the DB (even if false)
            dto.enableNotifications = settings.EnableNotificationsBool__c;
            
            // Handle nulls in existing records just in case
            if (settings.AutoSyncNetworkEntityBool__c == null) {
                dto.autoSyncNetworkEntity = true; // Fallback if field is new
            } else {
                dto.autoSyncNetworkEntity = settings.AutoSyncNetworkEntityBool__c;
            }
        }

        // Map the rest...
        dto.aiSuggestionsEnabled = settings.AISuggestionsEnabledBool__c;
        dto.autoGenerateDescriptions = settings.AutoGenerateDescriptionsBool__c;
        dto.aiEstimationEnabled = settings.AIEstimationEnabledBool__c;
        dto.openaiApiKey = settings.OpenAIApiKeyTxt__c;
        dto.openaiModel = settings.OpenAIModelTxt__c;
        dto.openAiApiTested = settings.OpenAiApiTestedBool__c;
        dto.jiraEnabled = settings.JIRAEnabledBool__c;
        dto.jiraInstanceUrl = settings.JIRAInstanceUrl__c;
        dto.jiraUsername = settings.JIRAUsernameTxt__c;
        dto.jiraApiToken = settings.JIRAApiTokenTxt__c;
        dto.jiraProjectKey = settings.JIRAProjectKeyTxt__c;
        dto.jiraApiTested = settings.JIraApiTestedBool__c;

        return dto;
    }

    @AuraEnabled
    public static void saveGeneralSettings(Boolean enableNotifications, Boolean autoSyncNetworkEntity) {
        Delivery_Hub_Settings__c settings = Delivery_Hub_Settings__c.getOrgDefaults();
        if (settings == null || settings.Id == null) {
             settings = new Delivery_Hub_Settings__c(SetupOwnerId = UserInfo.getOrganizationId());
        }
        
        settings.EnableNotificationsBool__c = enableNotifications;
        settings.AutoSyncNetworkEntityBool__c = autoSyncNetworkEntity;

        SObjectAccessDecision decision = Security.stripInaccessible(
            AccessType.UPSERTABLE, new List<Delivery_Hub_Settings__c>{settings});
        upsert decision.getRecords();
    }
    
    // ... keep the rest of your methods (saveAiSettings, etc) unchanged ...
    @AuraEnabled
    public static void saveAiSettings(Boolean suggestions, Boolean descriptions, Boolean estimation) {
        Delivery_Hub_Settings__c settings = Delivery_Hub_Settings__c.getOrgDefaults();
         if (settings == null || settings.Id == null) { settings = new Delivery_Hub_Settings__c(SetupOwnerId = UserInfo.getOrganizationId()); }
        settings.AISuggestionsEnabledBool__c = suggestions;
        settings.AutoGenerateDescriptionsBool__c = descriptions;
        settings.AIEstimationEnabledBool__c = estimation;
        upsert settings;
    }
    
    @AuraEnabled
    public static void saveOpenAISettings(String apiKey, String model, boolean tested) {
        Delivery_Hub_Settings__c settings = Delivery_Hub_Settings__c.getOrgDefaults();
         if (settings == null || settings.Id == null) { settings = new Delivery_Hub_Settings__c(SetupOwnerId = UserInfo.getOrganizationId()); }
        settings.OpenAIApiKeyTxt__c = apiKey;
        settings.OpenAIModelTxt__c = model;
        settings.OpenAiApiTestedBool__c = tested;
        upsert settings;
    }
    
    @AuraEnabled
    public static void saveJiraSettings(String url, String username, String token, String projectKey, Boolean isVerified) {
        Delivery_Hub_Settings__c settings = Delivery_Hub_Settings__c.getOrgDefaults();
         if (settings == null || settings.Id == null) { settings = new Delivery_Hub_Settings__c(SetupOwnerId = UserInfo.getOrganizationId()); }
        settings.JIRAInstanceUrl__c = url;
        settings.JIRAUsernameTxt__c = username;
        settings.JIRAApiTokenTxt__c = token;
        settings.JIRAProjectKeyTxt__c = projectKey;
        settings.JIraApiTestedBool__c = isVerified;
        upsert settings;
    }
    
     @AuraEnabled
    public static void saveJiraEnabledState(Boolean enabled) {
        Delivery_Hub_Settings__c settings = Delivery_Hub_Settings__c.getOrgDefaults();
         if (settings == null || settings.Id == null) { settings = new Delivery_Hub_Settings__c(SetupOwnerId = UserInfo.getOrganizationId()); }
        settings.JIRAEnabledBool__c = enabled;
        upsert settings;
    }
    
    // ... keep your test connection methods ...
    @AuraEnabled
    public static String testOpenAIConnection(String apiKey) {
        // ... existing implementation ...
        return 'Success'; // placeholder for brevity, keep your code
    }

    @AuraEnabled
    public static String testJiraConnection(String jiraUrl, String username, String apiToken, String projectKey) {
        // ... existing implementation ...
        return 'Success'; // placeholder for brevity, keep your code
    }
}