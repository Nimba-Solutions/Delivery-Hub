<template>
    <div class={rootClass}>
        <!-- Collapsed header / toggle row -->
        <div class="gs-header" onclick={handleToggle} role="button" tabindex="0" onkeydown={handleKeydown}>
            <div class="gs-header-left">
                <lightning-icon icon-name="utility:knowledge_base" size="x-small" class="gs-icon"></lightning-icon>
                <span class="gs-title">{headerTitle}</span>
                <template lwc:if={isAlreadyConnected}>
                    <span class="gs-connected-pill">Connected</span>
                </template>
            </div>
            <lightning-icon icon-name={chevronIcon} size="x-small" class="gs-chevron"></lightning-icon>
        </div>

        <!-- Expanded body -->
        <template lwc:if={isExpanded}>
            <div class="gs-body">

                <!-- Progress indicator -->
                <div class="wiz-progress">
                    <template for:each={progressSteps} for:item="step">
                        <div key={step.index} class="wiz-step">
                            <div class={step.stepClass}>{step.index}</div>
                            <span class="wiz-step-label">{step.label}</span>
                        </div>
                    </template>
                </div>

                <!-- ── STEP 1: Org Type ── -->
                <template lwc:if={isStep1}>
                    <div class="wiz-content">
                        <h3 class="wiz-heading">What type of org is this?</h3>
                        <p class="wiz-sub">This determines how Delivery Hub connects to the network.</p>
                        <div class="wiz-cards">
                            <button class="wiz-card" data-type="client" onclick={handleOrgTypeSelect}
                                    aria-pressed={isClientOrg}>
                                <lightning-icon icon-name="standard:account" size="medium"></lightning-icon>
                                <strong>Client Org</strong>
                                <span class="wiz-card-desc">I receive deliverables from a consulting partner.</span>
                                <template lwc:if={isClientOrg}>
                                    <span class="wiz-card-check">
                                        <lightning-icon icon-name="utility:check" size="xx-small"></lightning-icon>
                                    </span>
                                </template>
                            </button>
                            <button class="wiz-card" data-type="vendor" onclick={handleOrgTypeSelect}
                                    aria-pressed={isVendorOrg}>
                                <lightning-icon icon-name="standard:partners" size="medium"></lightning-icon>
                                <strong>Vendor / Consulting Org</strong>
                                <span class="wiz-card-desc">I deliver work to client organizations.</span>
                                <template lwc:if={isVendorOrg}>
                                    <span class="wiz-card-check">
                                        <lightning-icon icon-name="utility:check" size="xx-small"></lightning-icon>
                                    </span>
                                </template>
                            </button>
                        </div>
                        <div class="wiz-actions">
                            <lightning-button label="Next" variant="brand" onclick={handleNext}
                                              disabled={noOrgTypeSelected}></lightning-button>
                        </div>
                    </div>
                </template>

                <!-- ── STEP 2: Workflow Template ── -->
                <template lwc:if={isStep2}>
                    <div class="wiz-content">
                        <h3 class="wiz-heading">Choose your workflow</h3>
                        <p class="wiz-sub">Pick a workflow template that best matches how your team works. You can customize it later.</p>
                        <c-delivery-workflow-template-picker
                            compact
                            ontemplateselected={handleTemplateSelected}>
                        </c-delivery-workflow-template-picker>
                        <div class="wiz-actions">
                            <lightning-button label="Back" variant="neutral" onclick={handleBack}></lightning-button>
                            <lightning-button label="Next" variant="brand" onclick={handleNext}></lightning-button>
                        </div>
                    </div>
                </template>

                <!-- ── STEP 3: Partner Config ── -->
                <template lwc:if={isStep3}>
                    <div class="wiz-content">
                        <template lwc:if={isClientOrg}>
                            <h3 class="wiz-heading">Connect to your delivery partner</h3>
                            <p class="wiz-sub">
                                By default, your portal will connect to <strong>Cloud Nimbus LLC</strong> as your delivery partner.
                                This creates a secure two-way link for work item sync, updates, and collaboration.
                            </p>
                            <div class="wiz-info-box">
                                <lightning-icon icon-name="utility:connected_apps" size="x-small"></lightning-icon>
                                <span>Default partner: <strong>Cloud Nimbus LLC</strong></span>
                            </div>
                        </template>
                        <template lwc:if={isVendorOrg}>
                            <h3 class="wiz-heading">Configure your vendor hub</h3>
                            <p class="wiz-sub">
                                As a vendor org, your Delivery Hub instance becomes the central hub.
                                Client orgs will connect to you. Click <strong>Next</strong> to initialize your hub settings.
                            </p>
                            <div class="wiz-info-box">
                                <lightning-icon icon-name="utility:world" size="x-small"></lightning-icon>
                                <span>Your org will accept inbound connections from client organizations.</span>
                            </div>
                        </template>
                        <div class="wiz-actions">
                            <lightning-button label="Back" variant="neutral" onclick={handleBack}></lightning-button>
                            <lightning-button label="Next" variant="brand" onclick={handleNext}></lightning-button>
                        </div>
                    </div>
                </template>

                <!-- ── STEP 4: Test Connection ── -->
                <template lwc:if={isStep4}>
                    <div class="wiz-content">
                        <h3 class="wiz-heading">Establish connection</h3>
                        <template lwc:if={isClientOrg}>
                            <p class="wiz-sub">Click the button below to register your org with Cloud Nimbus LLC and set up sync jobs.</p>
                        </template>
                        <template lwc:if={isVendorOrg}>
                            <p class="wiz-sub">Click the button below to initialize default settings and schedule sync jobs.</p>
                        </template>

                        <template lwc:if={connectionError}>
                            <div class="wiz-error">
                                <lightning-icon icon-name="utility:error" size="x-small" variant="error"></lightning-icon>
                                <span>{connectionError}</span>
                            </div>
                        </template>

                        <div class="wiz-actions wiz-actions--center">
                            <lightning-button label="Back" variant="neutral" onclick={handleBack}></lightning-button>
                            <lightning-button label="Connect Now" variant="brand" onclick={handleConnect}
                                              disabled={isConnecting}
                                              icon-name="utility:connected_apps"></lightning-button>
                            <template lwc:if={isConnecting}>
                                <lightning-spinner size="small" alternative-text="Connecting..."></lightning-spinner>
                            </template>
                        </div>
                    </div>
                </template>

                <!-- ── STEP 5: Success ── -->
                <template lwc:if={isStep5}>
                    <div class="wiz-content wiz-content--success">
                        <div class="wiz-success-icon">
                            <lightning-icon icon-name="action:approval" size="large"></lightning-icon>
                        </div>
                        <h3 class="wiz-heading">You&apos;re all set!</h3>
                        <template lwc:if={isAlreadyConnected}>
                            <p class="wiz-sub">
                                Your portal is connected to <strong>{connectedEntityName}</strong>.
                                Sync jobs are running automatically to keep your work items in sync.
                            </p>
                        </template>
                        <template lwc:else>
                            <p class="wiz-sub">Setup is complete. Your delivery workflow is ready to use.</p>
                        </template>
                        <div class="wiz-actions wiz-actions--center">
                            <lightning-button label="Recheck Connection" variant="neutral"
                                              onclick={handleRecheck}
                                              icon-name="utility:refresh"
                                              disabled={isCheckingStatus}></lightning-button>
                        </div>
                    </div>
                </template>

            </div>
        </template>
    </div>
</template>
