<template>
    <lightning-card icon-name="standard:flow">
        <div slot="title" class="ac-title-wrapper">
            <span class="ac-card-title">Action Center</span>
            <template if:true={currentPhaseLabel}>
                <span class="ac-phase-chip">{currentPhaseLabel}</span>
            </template>
        </div>

        <div class="slds-p-horizontal_medium slds-p-bottom_medium">

            <!-- ── Current Stage Banner ── -->
            <div class="ac-stage-banner" style={stageBannerStyle}>
                <div class="ac-stage-name">{currentStage}</div>
                <template if:true={isFastTrackAvailable}>
                    <div class="ac-fast-track-badge">
                        <lightning-icon icon-name="utility:zap" size="xx-small" class="ac-zap-icon"></lightning-icon>
                        Fast Track
                    </div>
                </template>
            </div>

            <!-- ── Missing Fields ── -->
            <template if:true={hasMissingFields}>
                <div class="ac-missing-panel">
                    <div class="ac-missing-header">
                        <lightning-icon icon-name="utility:warning" size="xx-small"></lightning-icon>
                        <span class="ac-missing-title">Action Required to Advance</span>
                    </div>
                    <lightning-record-edit-form record-id={recordId} object-api-name="WorkItem__c" onsuccess={handleFixSuccess}>
                        <div class="ac-fields-grid">
                            <template for:each={missingFields} for:item="field">
                                <div key={field.apiName} class="ac-field-item">
                                    <p class="ac-field-reason">{field.reason}</p>
                                    <lightning-input-field field-name={field.apiName} variant="label-hidden"></lightning-input-field>
                                </div>
                            </template>
                        </div>
                        <div class="ac-save-row">
                            <lightning-button variant="brand" type="submit" label="Save Requirements" icon-name="utility:save" icon-position="left"></lightning-button>
                        </div>
                    </lightning-record-edit-form>
                </div>
            </template>

            <!-- ── Advance Options (hidden when required actions exist) ── -->
            <template if:true={showMoveOptions}>
            <template if:true={advanceOptions.length}>
                <div class="ac-section">
                    <div class="ac-section-label">
                        <lightning-icon icon-name="utility:forward" size="xx-small" class="ac-section-icon"></lightning-icon>
                        Advance
                    </div>
                    <div class="ac-advance-grid">
                        <template for:each={advanceOptions} for:item="opt">
                            <button
                                key={opt.stage}
                                class={opt.advanceBtnClass}
                                onclick={handleMove}
                                data-stage={opt.stage}
                                disabled={opt.disabled}
                                title={opt.disabledReason}>
                                <span class="ac-btn-label">{opt.label}</span>
                                <lightning-icon icon-name="utility:chevronright" size="xx-small" class="ac-btn-arrow"></lightning-icon>
                            </button>
                        </template>
                    </div>
                </div>
            </template>

            <!-- ── Backtrack Options (hidden when required actions exist) ── -->
            <template if:true={backtrackOptions.length}>
                <div class="ac-backtrack-section">
                    <span class="ac-backtrack-label">
                        <lightning-icon icon-name="utility:back" size="xx-small" class="ac-section-icon"></lightning-icon>
                        Backtrack
                    </span>
                    <div class="ac-backtrack-pills">
                        <template for:each={backtrackOptions} for:item="opt">
                            <button key={opt.stage} class="ac-backtrack-btn" onclick={handleMove} data-stage={opt.stage}>
                                {opt.label}
                            </button>
                        </template>
                    </div>
                </div>
            </template>
            </template><!-- end showMoveOptions -->

        </div>
    </lightning-card>
</template>
