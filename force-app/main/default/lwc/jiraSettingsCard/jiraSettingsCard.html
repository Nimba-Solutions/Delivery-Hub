<template>
    <div class="slds-card">
        <div class="slds-card__header slds-grid">
            <header class="slds-media slds-media_center slds-has-flexi-truncate">
                <div class="slds-media__figure">
                    <lightning-icon icon-name="utility:settings" alternative-text="JIRA Integration" size="small"></lightning-icon>
                </div>
                <div class="slds-media__body">
                    <h2 class="slds-card__header-title">
                        <span>JIRA Integration</span>
                    </h2>
                    <p class="slds-card__header-subtitle">Connect your JIRA instance to sync tickets and projects</p>
                </div>
            </header>
        </div>
        
        <div class="slds-card__body slds-card__body_inner">
            <!-- Enable JIRA Integration -->
            <div class="slds-form-element slds-m-bottom_large">
                <div class="slds-grid slds-grid_align-spread slds-grid_vertical-align-center">
                    <div class="slds-col">
                        <label class="slds-form-element__label slds-text-body_regular">Enable JIRA Integration</label>
                        <div class="slds-form-element__help">
                            Sync tickets between this Kanban board and your JIRA project
                        </div>
                    </div>
                    <div class="slds-col slds-no-flex">
                        <lightning-input
                            type="toggle"
                            checked={jiraEnabled}
                            onchange={handleJiraEnabledChange}>
                        </lightning-input>
                    </div>
                </div>
            </div>

            <div class="slds-border_top slds-m-vertical_medium"></div>

            <!-- JIRA Configuration -->
            <div class="slds-m-bottom_large">
                <!-- JIRA Instance URL -->
                <div class="slds-form-element slds-m-bottom_medium">
                    <label class="slds-form-element__label slds-text-body_small" for="jira-url">JIRA Instance URL</label>
                    <div class="slds-form-element__control">
                        <lightning-input
                            name="jira-url"
                            type="url"
                            value={jiraUrl}
                            placeholder="https://yourcompany.atlassian.net"
                            disabled={jiraEnabled}
                            onchange={handleJiraUrlChange}>
                        </lightning-input>
                    </div>
                </div>

                <!-- Username and Project Key -->
                <div class="slds-grid slds-gutters_medium slds-m-bottom_medium">
                    <div class="slds-col">
                        <div class="slds-form-element">
                            <label class="slds-form-element__label slds-text-body_small" for="jira-username">Username/Email</label>
                            <div class="slds-form-element__control">
                                <lightning-input
                                    name="jira-username"
                                    type="email"
                                    value={jiraUsername}
                                    placeholder="your.email@company.com"
                                    disabled={jiraEnabled}
                                    onchange={handleJiraUsernameChange}>
                                </lightning-input>
                            </div>
                        </div>
                    </div>
                    <div class="slds-col">
                        <div class="slds-form-element">
                            <label class="slds-form-element__label slds-text-body_small" for="jira-project-key">Project Key</label>
                            <div class="slds-form-element__control">
                                <lightning-input
                                    name="jira-project-key"
                                    value={jiraProjectKey}
                                    placeholder="PROJ"
                                    disabled={jiraEnabled}
                                    onchange={handleJiraProjectKeyChange}>
                                </lightning-input>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- API Token -->
                <div class="slds-form-element slds-m-bottom_medium">
                    <label class="slds-form-element__label slds-text-body_small" for="jira-token">API Token</label>
                    <div class="slds-form-element__control">
                        <div class="slds-grid slds-grid_align-end slds-gutters_small">
                            <div class="slds-col slds-grow">
                                <div class="slds-form-element__control slds-input-has-icon slds-input-has-icon_right">
                                    <lightning-input
                                        name="jira-token"
                                        type={apiTokenInputType}
                                        value={jiraApiToken}
                                        placeholder="Your JIRA API token"
                                        disabled={jiraEnabled}
                                        onchange={handleJiraApiTokenChange}>
                                    </lightning-input>
                                    <button class="slds-button slds-button_icon slds-input__icon slds-input__icon_right" 
                                            onclick={toggleApiTokenVisibility} 
                                            type="button"
                                            disabled={jiraEnabled}
                                            title="Toggle API Token Visibility">
                                        <lightning-icon icon-name={eyeIconName} size="x-small" alternative-text="Toggle visibility"></lightning-icon>
                                        <span class="slds-assistive-text">Toggle API Token Visibility</span>
                                    </button>
                                </div>
                            </div>
                            <div class="slds-col slds-no-flex">
                                <lightning-button
                                    label={testButtonLabel}
                                    onclick={testJiraConnection}
                                    disabled={isTestButtonDisabled}
                                    variant="outline-brand"
                                    icon-name="utility:test"
                                    icon-position="left">
                                </lightning-button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Test Results -->
                <template if:true={showSuccessAlert}>
                    <div class="slds-notify slds-notify_alert slds-alert_success slds-m-bottom_medium" role="alert">
                        <span class="slds-assistive-text">Success</span>
                        <div class="slds-media slds-media_center">
                            <div class="slds-media__figure">
                                <lightning-icon icon-name="utility:success" alternative-text="Success" size="x-small" variant="inverse"></lightning-icon>
                            </div>
                            <div class="slds-media__body">
                                <p>Successfully connected to JIRA!</p>
                            </div>
                        </div>
                    </div>
                </template>
                
                <template if:true={showErrorAlert}>
                    <div class="slds-notify slds-notify_alert slds-alert_error slds-m-bottom_medium" role="alert">
                        <span class="slds-assistive-text">Error</span>
                        <div class="slds-media slds-media_center">
                            <div class="slds-media__figure">
                                <lightning-icon icon-name="utility:error" alternative-text="Error" size="x-small" variant="inverse"></lightning-icon>
                            </div>
                            <div class="slds-media__body">
                                <p>Failed to connect to JIRA. Please check your configuration.</p>
                            </div>
                        </div>
                    </div>
                </template>
            </div>

            <div class="slds-border_top slds-m-vertical_medium"></div>

            <!-- Actions -->
            <div class="slds-grid slds-grid_align-spread slds-m-bottom_large">
                <div class="slds-col">
                    <lightning-button
                        label="Reset Settings"
                        onclick={resetJiraSettings}
                        variant="destructive-text">
                    </lightning-button>
                </div>
            </div>

            <div class="slds-border_top slds-m-vertical_medium"></div>

            <!-- Setup Guide -->
            <div class="info-section slds-p-around_medium slds-m-bottom_medium">
                <h4 class="slds-text-heading_small slds-m-bottom_small">How to set up JIRA Integration:</h4>
                <ol class="setup-list slds-text-body_small slds-text-color_weak">
                    <li class="slds-m-bottom_x-small">1. <strong>Get your JIRA URL:</strong> Usually https://yourcompany.atlassian.net</li>
                    <li class="slds-m-bottom_x-small">2. <strong>Create an API Token:</strong>
                        <ul class="slds-m-left_medium slds-m-top_xx-small">
                            <li>• Go to id.atlassian.com/manage-profile/security/api-tokens</li>
                            <li>• Click "Create API token"</li>
                            <li>• Give it a name and copy the token</li>
                        </ul>
                    </li>
                    <li class="slds-m-bottom_x-small">3. <strong>Find your Project Key:</strong> Usually visible in your JIRA project URL</li>
                    <li class="slds-m-bottom_x-small">4. <strong>Use your email:</strong> The email you use to log into JIRA</li>
                </ol>
                <lightning-button
                    label="Create JIRA API Token"
                    onclick={openJiraTokenPage}
                    variant="outline-brand"
                    icon-name="utility:new_window"
                    icon-position="left"
                    class="slds-m-top_small">
                </lightning-button>
            </div>

            <!-- Features Info -->
            <div class="info-section slds-p-around_medium">
                <h4 class="slds-text-heading_small slds-m-bottom_small">What you can do with JIRA Integration:</h4>
                <ul class="slds-text-body_small slds-text-color_weak">
                    <li class="slds-m-bottom_xx-small">• Sync tickets automatically between Kanban board and JIRA</li>
                    <li class="slds-m-bottom_xx-small">• Create JIRA issues directly from the Kanban board</li>
                    <li class="slds-m-bottom_xx-small">• Keep status updates synchronized</li>
                    <li>• Import existing JIRA issues into your board</li>
                </ul>
            </div>
        </div>
    </div>
</template>